#include <WiFi.h>
#include <WebServer.h>
#include <BLEDevice.h>
#include <BLEScan.h>

const char* s="ESP32";
const char* p="12345678";

WebServer sv(80);
BLEScan* sc=0;
bool bleOn=0;

void hR(){
  String h="<html><body style='background:#000;color:#0f0;'>";
  
  // WiFi сканер
  int n=WiFi.scanNetworks();
  h+="<p>WiFi:"+String(n)+"</p>";
  for(int i=0;i<n&&i<3;i++){
    h+="<p>"+WiFi.SSID(i)+":"+String(WiFi.RSSI(i))+"dBm</p>";
  }
  
  // Кнопки
  h+="<button onclick='fetch(\"/wifi\")'>WiFi Scan</button><br>";
  h+="<button onclick='fetch(\"/ble\")'>"+(bleOn?"Stop BLE":"Start BLE")+"</button><br>";
  h+="<button onclick='fetch(\"/fake\")'>Create FakeAP</button><br>";
  
  h+="</body></html>";
  sv.send(200,"text/html",h);
  WiFi.scanDelete();
}

void hWiFi(){ sv.send(200,"text/plain","Scanning WiFi..."); }

void hBLE(){
  bleOn=!bleOn;
  if(bleOn&&!sc){
    BLEDevice::init("");
    sc=BLEDevice::getScan();
    sc->setActiveScan(1);
  }
  sv.send(200,"text/plain",bleOn?"BLE ON":"BLE OFF");
}

void hFake(){
  WiFi.softAP("FakeAP",NULL);
  sv.send(200,"text/plain","FakeAP created");
}

void setup(){
  WiFi.softAP(s,p);
  sv.on("/",hR);
  sv.on("/wifi",hWiFi);
  sv.on("/ble",hBLE);
  sv.on("/fake",hFake);
  sv.begin();
  pinMode(2,OUTPUT);
}

void loop(){
  sv.handleClient();
  if(bleOn&&sc){
    sc->start(1,0);
    sc->clearResults();
    digitalWrite(2,!digitalRead(2));
  }
  delay(10);
}
