#include <WiFi.h>
#include <WebServer.h>
#include <BLEDevice.h>
#include <BLEScan.h>

const char* s="ESP32";
const char* p="12345678";
WebServer sv(80);
BLEScan* sc=0;
bool jamming=0;

void hR(){
  String h="<html><body><h1>Scan</h1>";
  int n=WiFi.scanNetworks();
  h+="<p>Found:"+String(n)+"</p>";
  for(int i=0;i<n&&i<5;i++){
    h+="<p>"+WiFi.SSID(i)+":"+String(WiFi.RSSI(i))+"dBm</p>";
  }
  h+="<button onclick='fetch(\"/jam\")'>"+(jamming?"STOP":"START")+" Jam</button>";
  h+="</body></html>";
  sv.send(200,"text/html",h);
  WiFi.scanDelete();
}

void hJ(){
  jamming=!jamming;
  if(jamming && !sc){
    BLEDevice::init("");
    sc=BLEDevice::getScan();
    sc->setActiveScan(1);
    sc->setInterval(5);
    sc->setWindow(4);
  }
  sv.send(200,"text/plain",jamming?"Jamming ON":"Jamming OFF");
}

void setup(){
  WiFi.softAP(s,p);
  sv.on("/",hR);
  sv.on("/jam",hJ);
  sv.begin();
  pinMode(2,OUTPUT);
}

void loop(){
  sv.handleClient();
  if(jamming && sc){
    sc->start(1,false);
    sc->clearResults();
    digitalWrite(2,!digitalRead(2)); // Быстро мигает
  }else{
    digitalWrite(2,LOW);
  }
  delay(10);
}
